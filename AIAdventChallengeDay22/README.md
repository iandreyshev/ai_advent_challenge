# День 22: Ассистент для поддержки пользователей

Мини-сервис технической поддержки для продукта **TaskFlow** (платформа управления задачами).

## Архитектура

Система состоит из двух компонентов:

### 1. MCP-сервер (`hotels-mcp/`)
Kotlin-приложение на базе Ktor, предоставляющее MCP (Model Context Protocol) инструменты для работы с:
- Информацией о пользователях
- Тикетами поддержки
- Историей обращений

**Инструменты MCP:**
- `get_user_info` - получение информации о пользователе
- `get_ticket` - детали тикета
- `search_tickets` - поиск тикетов по фильтрам
- `get_user_tickets` - все тикеты пользователя

### 2. Клиентское приложение (`support-assistant/`)
Kotlin-приложение, реализующее RAG (Retrieval-Augmented Generation):
- Работает с локальными эмбеддингами через **Ollama** (модель `nomic-embed-text`)
- Индексирует документацию и FAQ в векторную базу данных
- Интегрируется с **Яндекс.Агентом** (YandexGPT API)
- Использует MCP-сервер для получения контекста о пользователях

## Функциональность

Ассистент отвечает на вопросы пользователей, используя:
1. **RAG**: поиск релевантной информации в документации
2. **MCP**: контекст пользователя и его тикетов из "CRM"
3. **YandexGPT**: генерация качественного ответа (или fallback на Ollama)

### Пример работы

**Вопрос:** "Почему не работает авторизация через Google?"

**Система:**
1. Ищет в документации раздел про OAuth аутентификацию
2. Получает информацию о пользователе (план, статус)
3. Проверяет историю тикетов пользователя
4. Находит текущий тикет с описанием проблемы
5. Генерирует ответ с учетом всего контекста

## Требования

- **JDK 17+**
- **Ollama** с моделью `nomic-embed-text`
- **Yandex Cloud API** (опционально, для YandexGPT)

## Установка

### 1. Установка Ollama

```bash
# macOS
brew install ollama

# Linux
curl -fsSL https://ollama.com/install.sh | sh

# Windows
# Скачать с https://ollama.com/download
```

### 2. Загрузка модели эмбеддингов

```bash
ollama pull nomic-embed-text
```

### 3. Запуск Ollama

```bash
ollama serve
```

Ollama будет доступна на `http://localhost:11434`

### 4. Настройка Yandex Cloud (опционально)

Для использования YandexGPT:

1. Создайте аккаунт на https://cloud.yandex.ru
2. Создайте API ключ
3. Получите Folder ID
4. Установите переменные окружения:

```bash
export YANDEX_API_KEY="your_api_key"
export YANDEX_FOLDER_ID="your_folder_id"
```

**Без Yandex Cloud** система будет работать с локальной моделью через Ollama.

## Запуск

### 1. Запуск MCP-сервера

```bash
cd hotels-mcp
./gradlew run
```

Сервер запустится на `http://localhost:8080`

### 2. Запуск клиентского приложения

В отдельном терминале:

```bash
cd support-assistant
./gradlew run
```

Приложение:
1. Подключится к Ollama
2. Загрузит и проиндексирует документацию
3. Запустит тестовые запросы

## Структура проекта

```
AIAdventChallengeDay22/
├── hotels-mcp/                    # MCP-сервер
│   └── src/main/
│       ├── kotlin/
│       │   ├── Application.kt     # Точка входа Ktor
│       │   ├── MCPServer.kt       # MCP инструменты
│       │   └── Routing.kt         # Роутинг
│       └── resources/
│           ├── support.json       # CRM данные (пользователи, тикеты)
│           └── docs/              # Документация для RAG
│               ├── authentication.txt
│               ├── tasks.txt
│               ├── notifications.txt
│               ├── sync.txt
│               ├── billing.txt
│               └── faq.txt
│
└── support-assistant/             # Клиентское приложение
    └── src/main/kotlin/ru/iandreyshev/assistant/
        ├── Main.kt                # Точка входа
        ├── OllamaClient.kt        # Клиент для Ollama
        ├── VectorStore.kt         # Векторная БД (in-memory)
        ├── RAGSystem.kt           # RAG логика
        ├── YandexAgentClient.kt   # Клиент YandexGPT
        └── SupportAssistant.kt    # Главный класс
```

## Данные

### Продукт: TaskFlow
SaaS-платформа для управления задачами команды.

### Тестовые тикеты
- Проблемы с авторизацией (OAuth)
- Невозможность создать задачу
- Не приходят уведомления
- Проблемы с синхронизацией
- Вопросы о тарифах

### Документация
- Аутентификация (OAuth, восстановление пароля)
- Работа с задачами (создание, редактирование)
- Уведомления (email, push)
- Синхронизация между устройствами
- Тарифы и оплата
- FAQ

## Примеры запросов

Система автоматически запускает тестовые запросы:

1. **"Почему не работает авторизация через Google?"**
   - User: user001 (Pro план)
   - Ticket: ticket001 (OAuth проблема)

2. **"Не могу создать задачу, кнопка не работает"**
   - User: user002 (Free план)
   - Ticket: ticket002 (UI проблема)

3. **"Не приходят уведомления на email"**
   - User: user003 (Business план)
   - Ticket: ticket003 (Email проблема)

## Как это работает

### RAG Pipeline

1. **Индексация** (при запуске):
   ```
   Документация → Разбиение на чанки → Ollama embeddings → Vector Store
   ```

2. **Поиск** (при запросе):
   ```
   Вопрос → Ollama embedding → Поиск похожих чанков → Top-3 документа
   ```

### Генерация ответа

```
┌─────────────────┐
│  Вопрос юзера   │
└────────┬────────┘
         │
         ├─────────────────┐
         │                 │
         v                 v
┌──────────────┐   ┌──────────────┐
│  RAG поиск   │   │  MCP запрос  │
│ (документы)  │   │  (контекст)  │
└──────┬───────┘   └──────┬───────┘
       │                  │
       └────────┬─────────┘
                v
        ┌───────────────┐
        │  Объединение  │
        │   контекста   │
        └───────┬───────┘
                │
                v
        ┌───────────────┐
        │  YandexGPT /  │
        │    Ollama     │
        └───────┬───────┘
                │
                v
        ┌───────────────┐
        │     Ответ     │
        └───────────────┘
```

## Интеграция с Яндекс-агентом

MCP-сервер предназначен для подключения к Яндекс-агенту через Model Context Protocol.

**Конфигурация для Яндекс-агента:**
```json
{
  "mcpServers": {
    "support": {
      "url": "http://localhost:8080/mcp",
      "tools": [
        "get_user_info",
        "get_ticket",
        "search_tickets",
        "get_user_tickets"
      ]
    }
  }
}
```

## Дополнительные возможности

### Расширение документации
Добавьте `.txt` или `.md` файлы в `hotels-mcp/src/main/resources/docs/`

### Добавление тикетов
Отредактируйте `hotels-mcp/src/main/resources/support.json`

### Изменение модели эмбеддингов
В `support-assistant/src/main/kotlin/ru/iandreyshev/assistant/Main.kt`:
```kotlin
val ollamaClient = OllamaClient(
    httpClient,
    embeddingModel = "mxbai-embed-large" // или другая модель
)
```

### Использование другой LLM
Измените fallback модель в `OllamaClient.generateResponse()`:
```kotlin
ollamaClient.generateResponse(prompt, model = "llama3")
```

## Troubleshooting

### Ollama не отвечает
```bash
# Проверьте статус
curl http://localhost:11434/api/tags

# Перезапустите Ollama
pkill ollama
ollama serve
```

### MCP-сервер не запускается
```bash
# Проверьте порт 8080
lsof -i :8080

# Измените порт в application.yaml
```

### Ошибки с эмбеддингами
```bash
# Убедитесь, что модель загружена
ollama list

# Загрузите модель
ollama pull nomic-embed-text
```

## Выполнение задания

✅ **Сделан мини-сервис поддержки**
- Отвечает на вопросы пользователей о продукте TaskFlow

✅ **RAG реализован**
- Использует документацию и FAQ
- Векторный поиск через Ollama embeddings

✅ **MCP интеграция**
- "CRM" система (JSON) с пользователями и тикетами
- 4 MCP инструмента для доступа к данным
- Готов к подключению к Яндекс-агенту

✅ **Контекстные ответы**
- Учитывает контекст тикета
- Использует историю обращений пользователя
- Адаптирует ответ под тарифный план

## Результат

Полнофункциональный ассистент технической поддержки, который:
- Ищет решения в документации (RAG)
- Понимает контекст пользователя (MCP + "CRM")
- Генерирует качественные ответы (YandexGPT/Ollama)

**Пример вывода:**
```
ВОПРОС: Почему не работает авторизация через Google?
User ID: user001, Ticket ID: ticket001
------------------------------------------------------------
ОТВЕТ:

Судя по вашему тикету, вы получаете ошибку "Invalid redirect URI"
при попытке войти через Google OAuth.

Это происходит по следующим причинам:
1. Неправильный домен в настройках OAuth
2. Redirect URI не зарегистрирован в Google Console
3. Опечатка в redirect URL

Решение:
1. Проверьте настройки OAuth приложения в Google Cloud Console
2. Убедитесь, что redirect URI совпадает с используемым
3. Очистите кэш браузера и cookies
4. Попробуйте режим инкогнито

Также обратите внимание, что у вас Pro план, который включает
приоритетную поддержку. Если проблема не решится, мы можем
проверить ваши настройки напрямую.
```

## Лицензия

MIT
