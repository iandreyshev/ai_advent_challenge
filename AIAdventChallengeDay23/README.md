# День 23: Ассистент команды разработки

Ассистент команды разработки для продукта **TaskFlow** (платформа управления задачами).

## Архитектура

Система состоит из двух компонентов:

### 1. MCP-сервер (`tasks-mcp/`)
Kotlin-приложение на базе Ktor, предоставляющее MCP (Model Context Protocol) инструменты для работы с:
- Информацией о членах команды
- Задачами разработки
- Проектами
- Создание новых задач

**Инструменты MCP:**
- `get_user_info` - получение информации о члене команды
- `get_task` - детали задачи
- `search_tasks` - поиск задач по фильтрам (status, priority, assignee, project)
- `get_user_tasks` - все задачи пользователя
- `create_task` - создание новой задачи

### 2. Клиентское приложение (`team-assistant/`)
Kotlin-приложение, реализующее RAG (Retrieval-Augmented Generation) с нативным MCP tool calling:
- Работает с локальными эмбеддингами через **Ollama** (модель `nomic-embed-text`)
- Индексирует документацию по управлению задачами в векторную базу данных
- Использует **llama3.2** через Ollama с нативной поддержкой tool calling
- MCP инструменты подключены напрямую к модели - llama3.2 сама решает когда и какие инструменты вызывать
- Поддержка настройки **temperature** для контроля креативности ответов (по умолчанию 0.7)

## Функциональность

Ассистент помогает команде управлять задачами, используя:
1. **RAG**: поиск релевантной информации в документации по приоритизации и работе с задачами
2. **MCP с нативным tool calling**: модель llama3.2 напрямую подключена к 5 MCP инструментам и сама решает когда их вызывать
3. **Ollama (llama3.2)**: генерация рекомендаций и ответов с нативной поддержкой tool calling

### Пример работы

**Вопрос:** "Покажи задачи с приоритетом high и предложи, что делать первым"

**Система:**
1. **RAG** ищет в документации правила приоритизации задач
2. **llama3.2** получает вопрос и документацию, анализирует что нужна информация о задачах
3. **llama3.2 сама решает** вызвать инструмент `search_tasks` с фильтром `priority=high`
4. **MCP** возвращает список задач с высоким приоритетом
5. **llama3.2** может дополнительно вызвать другие инструменты (например, проверить блокеры через `search_tasks` с `status=blocked`)
6. **llama3.2** анализирует полученные данные и генерирует конкретные рекомендации по порядку выполнения задач

**Ключевое отличие**: Модель сама решает какие инструменты вызывать и в каком порядке, система не предопределяет логику вызовов.

## Требования

- **JDK 17+**
- **Ollama** с моделями:
  - `nomic-embed-text` (для embeddings)
  - `llama3.2` (для генерации с tool calling)

## Установка

### 1. Установка Ollama

```bash
# macOS
brew install ollama

# Linux
curl -fsSL https://ollama.com/install.sh | sh

# Windows
# Скачать с https://ollama.com/download
```

### 2. Загрузка моделей

```bash
# Модель для embeddings (векторный поиск)
ollama pull nomic-embed-text

# Модель для генерации с tool calling
ollama pull llama3.2
```

### 3. Запуск Ollama

```bash
ollama serve
```

Ollama будет доступна на `http://localhost:11434`

### 4. Настройка Yandex Cloud (опционально)

Для использования YandexGPT:

1. Создайте аккаунт на https://cloud.yandex.ru
2. Создайте API ключ
3. Получите Folder ID
4. Установите переменные окружения:

```bash
export YANDEX_API_KEY="your_api_key"
export YANDEX_FOLDER_ID="your_folder_id"
```

**Без Yandex Cloud** система будет работать с локальной моделью через Ollama.

## Запуск

### 1. Запуск MCP-сервера

```bash
cd tasks-mcp
./gradlew run
```

Сервер запустится на `http://localhost:8080`

### 2. Запуск клиентского приложения

В отдельном терминале:

```bash
cd team-assistant
./gradlew run
```

Приложение:
1. Подключится к Ollama
2. Загрузит и проиндексирует документацию
3. Запустит тестовые запросы

## Структура проекта

```
AIAdventChallengeDay23/
├── tasks-mcp/                     # MCP-сервер
│   └── src/main/
│       ├── kotlin/
│       │   ├── Application.kt     # Точка входа Ktor
│       │   ├── MCPServer.kt       # MCP инструменты для работы с задачами
│       │   └── Routing.kt         # REST API роутинг
│       └── resources/
│           ├── tasks.json         # База задач (users, projects, tasks)
│           └── docs/              # Документация для RAG
│               ├── team_management.txt  # Управление задачами и приоритизация
│               ├── tasks.txt            # Работа с задачами
│               ├── authentication.txt
│               ├── notifications.txt
│               ├── sync.txt
│               ├── billing.txt
│               └── faq.txt
│
└── team-assistant/                # Клиентское приложение
    └── src/main/kotlin/ru/iandreyshev/assistant/
        ├── Main.kt                # Точка входа с тестовыми запросами
        ├── SupportAssistant.kt    # Главный класс (анализ и рекомендации)
        ├── RAGSystem.kt           # RAG логика
        ├── VectorStore.kt         # Векторная БД (in-memory)
        └── OllamaClient.kt        # Клиент для Ollama (embeddings + llama3.1)
```

## Данные

### Продукт: TaskFlow
SaaS-платформа для управления задачами команды.

### Тестовые тикеты
- Проблемы с авторизацией (OAuth)
- Невозможность создать задачу
- Не приходят уведомления
- Проблемы с синхронизацией
- Вопросы о тарифах

### Документация
- Аутентификация (OAuth, восстановление пароля)
- Работа с задачами (создание, редактирование)
- Уведомления (email, push)
- Синхронизация между устройствами
- Тарифы и оплата
- FAQ

## Примеры запросов

Система автоматически запускает тестовые запросы:

1. **"Почему не работает авторизация через Google?"**
   - User: user001 (Pro план)
   - Ticket: ticket001 (OAuth проблема)

2. **"Не могу создать задачу, кнопка не работает"**
   - User: user002 (Free план)
   - Ticket: ticket002 (UI проблема)

3. **"Не приходят уведомления на email"**
   - User: user003 (Business план)
   - Ticket: ticket003 (Email проблема)

## Как это работает

### RAG Pipeline

1. **Индексация** (при запуске):
   ```
   Документация → Разбиение на чанки → Ollama embeddings → Vector Store
   ```

2. **Поиск** (при запросе):
   ```
   Вопрос → Ollama embedding → Поиск похожих чанков → Top-3 документа
   ```

### Генерация ответа

```
┌─────────────────┐
│  Вопрос юзера   │
└────────┬────────┘
         │
         ├─────────────────┐
         │                 │
         v                 v
┌──────────────┐   ┌──────────────┐
│  RAG поиск   │   │  MCP запрос  │
│ (документы)  │   │  (контекст)  │
└──────┬───────┘   └──────┬───────┘
       │                  │
       └────────┬─────────┘
                v
        ┌───────────────┐
        │  Объединение  │
        │   контекста   │
        └───────┬───────┘
                │
                v
        ┌───────────────┐
        │  YandexGPT /  │
        │    Ollama     │
        └───────┬───────┘
                │
                v
        ┌───────────────┐
        │     Ответ     │
        └───────────────┘
```

## Интеграция с Яндекс-агентом

MCP-сервер предназначен для подключения к Яндекс-агенту через Model Context Protocol.

**Конфигурация для Яндекс-агента:**
```json
{
  "mcpServers": {
    "support": {
      "url": "http://localhost:8080/mcp",
      "tools": [
        "get_user_info",
        "get_ticket",
        "search_tickets",
        "get_user_tickets"
      ]
    }
  }
}
```

## Дополнительные возможности

### Настройка Temperature

Temperature контролирует "креативность" ответов модели:

- **0.0 - 0.3**: Детерминированные, точные ответы (для фактов и данных)
- **0.4 - 0.6**: Сбалансированные ответы (стандартное использование)
- **0.7 - 0.9**: Креативные ответы (для рекомендаций и анализа)
- **1.0+**: Очень креативные, но менее предсказуемые ответы

Настройка в `Main.kt`:
```kotlin
TestQuery(
    question = "Покажи задачи с high priority",
    temperature = 0.7  // Значение по умолчанию
)
```

Или программно:
```kotlin
assistant.answerQuestion(
    question = "Ваш вопрос",
    temperature = 0.5  // Более консервативные ответы
)
```

**Рекомендации:**
- Для списка задач: `0.3-0.5` (точность важнее)
- Для рекомендаций: `0.7-0.8` (баланс точности и креативности)
- Для креативного анализа: `0.8-1.0` (приоритет креативности)

### Расширение документации
Добавьте `.txt` или `.md` файлы в `tasks-mcp/src/main/resources/docs/`

### Добавление задач
Отредактируйте `tasks-mcp/src/main/resources/tasks.json`

### Изменение модели эмбеддингов
В `team-assistant/src/main/kotlin/ru/iandreyshev/assistant/Main.kt`:
```kotlin
val ollamaClient = OllamaClient(
    httpClient,
    embeddingModel = "mxbai-embed-large" // или другая модель
)
```

### Использование другой LLM
Измените модель в `SupportAssistant.kt`:
```kotlin
ollamaClient.generateWithTools(
    model = "llama3.2:latest",  // или другая версия
    temperature = 0.7
)
```

## Troubleshooting

### Ollama не отвечает
```bash
# Проверьте статус
curl http://localhost:11434/api/tags

# Перезапустите Ollama
pkill ollama
ollama serve
```

### MCP-сервер не запускается
```bash
# Проверьте порт 8080
lsof -i :8080

# Измените порт в application.yaml
```

### Ошибки с эмбеддингами
```bash
# Убедитесь, что модель загружена
ollama list

# Загрузите модель
ollama pull nomic-embed-text
```

## Выполнение задания

✅ **Сделан мини-сервис поддержки**
- Отвечает на вопросы пользователей о продукте TaskFlow

✅ **RAG реализован**
- Использует документацию и FAQ
- Векторный поиск через Ollama embeddings

✅ **MCP интеграция**
- "CRM" система (JSON) с пользователями и тикетами
- 4 MCP инструмента для доступа к данным
- Готов к подключению к Яндекс-агенту

✅ **Контекстные ответы**
- Учитывает контекст тикета
- Использует историю обращений пользователя
- Адаптирует ответ под тарифный план

## Результат

Полнофункциональный ассистент технической поддержки, который:
- Ищет решения в документации (RAG)
- Понимает контекст пользователя (MCP + "CRM")
- Генерирует качественные ответы (YandexGPT/Ollama)

**Пример вывода:**
```
ВОПРОС: Почему не работает авторизация через Google?
User ID: user001, Ticket ID: ticket001
------------------------------------------------------------
ОТВЕТ:

Судя по вашему тикету, вы получаете ошибку "Invalid redirect URI"
при попытке войти через Google OAuth.

Это происходит по следующим причинам:
1. Неправильный домен в настройках OAuth
2. Redirect URI не зарегистрирован в Google Console
3. Опечатка в redirect URL

Решение:
1. Проверьте настройки OAuth приложения в Google Cloud Console
2. Убедитесь, что redirect URI совпадает с используемым
3. Очистите кэш браузера и cookies
4. Попробуйте режим инкогнито

Также обратите внимание, что у вас Pro план, который включает
приоритетную поддержку. Если проблема не решится, мы можем
проверить ваши настройки напрямую.
```

## Лицензия

MIT
